<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:osgi="http://www.springframework.org/schema/osgi"
	xmlns:jee="http://www.springframework.org/schema/jee"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd
		http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.0.xsd">

	<!-- System properties -->
	<osgi:reference id="notifServProperties" interface="java.util.Properties" filter="(nsResourceName=notifServProperties)"/>

	<!-- OSGi Service References -->
	<osgi:reference id="applicationDaoService" interface="com.railinc.notifserv.app.dao.ApplicationDao"/>
	<osgi:reference id="eventMarshallerService" interface="com.railinc.notifserv.event.model.EventMarshaller"/>
	<osgi:reference id="nsMailSession" interface="com.railinc.notifserv.mail.NotifServMailSession" filter="(nsResourceName=notifServMailSession)"/>
	<osgi:list id="xmlOverTrainIIFormattingOptions" interface="com.railinc.notifserv.senders.TrainIIFormattingOptions" cardinality="0..N"/>

	<!-- ########## Admin Email Failed Event Service ######### -->
	<bean id="adminFailedEventEmailMessageBuilder" class="com.railinc.notifserv.senders.impl.internal.AdminFailedEventMessageBuilderImpl">
        <property name="notifServProperties" ref="notifServProperties"/>
	</bean>

	<bean id="adminFailedEventEmailMessageSender" class="com.railinc.notifserv.senders.impl.EmailSenderServiceImpl">
		<constructor-arg value="DEFAULT"/>
		<property name="msgBuilder" ref="adminFailedEventEmailMessageBuilder"/>
		<property name="mailSession" ref="nsMailSession"/>
	</bean>

	<bean id="adminEmailFailedEvent" class="com.railinc.notifserv.senders.impl.AdminEmailFailedEventNotifierImpl">
		<property name="applicationDao" ref="applicationDaoService"/>
		<property name="eventMarshaller" ref="eventMarshallerService"/>
		<property name="emailSender" ref="adminFailedEventEmailMessageSender"/>
	</bean>
	<osgi:service id="adminEmailFailedEventService" ref="adminEmailFailedEvent" interface="com.railinc.notifserv.senders.AdminEmailFailedEventNotifier"  context-class-loader="service-provider"/>

	<!-- ########## Email Sender Service ########## -->
	<bean id="emailMessageBuilder" class="com.railinc.notifserv.senders.impl.internal.EmailMessageBuilderImpl">
        <property name="notifServProperties" ref="notifServProperties"/>
	</bean>

	<bean id="emailMessageSender" class="com.railinc.notifserv.senders.impl.EmailSenderServiceImpl">
		<constructor-arg value="DEFAULT"/>
		<property name="msgBuilder" ref="emailMessageBuilder"/>
		<property name="mailSession" ref="nsMailSession"/>
		<property name="notifServProperties" ref="notifServProperties"/>
	</bean>

	<osgi:service id="emailMessageSenderService" ref="emailMessageSender" context-class-loader="service-provider">
		<osgi:interfaces>
			<value>com.railinc.notifserv.senders.SenderService</value>
			<value>com.railinc.notifserv.senders.EmailSenderService</value>
		</osgi:interfaces>
	</osgi:service>

	<!-- ########## MQ Sender Service ########## -->

	<osgi:reference id="nsRmsConnectionFactoryService" interface="javax.jms.ConnectionFactory" filter="(nsResourceName=notifServRmsConnectionFactory)"/>

	<osgi:reference id="nsRmsMsgQueueService" interface="com.ibm.mq.jms.MQQueue" filter="(nsResourceName=notifServRmsMsgQueue)"/>

	<bean id="nsRmsMsgTemplate" class="org.springframework.jms.core.JmsTemplate">
		<constructor-arg ref="myConnectionFactory"/>
		<property name="defaultDestination" ref="nsRmsMsgQueueService"/>
	</bean>

	<bean id="myConnectionFactory"
		class="org.springframework.jms.connection.UserCredentialsConnectionFactoryAdapter">
		<property name="targetConnectionFactory">
			<ref bean="nsRmsConnectionFactoryService" />
		</property>
		<property name="username">
			<value> </value>
		</property>
		<property name="password">
			<value> </value>
		</property>
	</bean>

	<bean id="mqMessageBuilder" class="com.railinc.notifserv.senders.impl.internal.MqMessageBuilderImpl">
		<property name="options" ref="xmlOverTrainIIFormattingOptions"/>
	</bean>

	<bean id="mqMessageSender" class="com.railinc.notifserv.senders.impl.MqSenderServiceImpl">
		<constructor-arg value="DEFAULT"/>
		<constructor-arg ref="nsRmsMsgTemplate"/>
		<constructor-arg ref="mqMessageBuilder"/>
	</bean>

	<osgi:service id="mqMessageSenderService" ref="mqMessageSender" interface="com.railinc.notifserv.senders.SenderService"/>

	<!-- ########## FTP Sender Service ########## -->

	<bean id="ftpViaMqMessageSender" class="com.railinc.notifserv.senders.impl.FtpViaMqSenderServiceImpl">
		<constructor-arg value="DEFAULT"/>
		<constructor-arg ref="nsRmsMsgTemplate"/>
		<constructor-arg ref="mqMessageBuilder"/>
	</bean>

	<osgi:service id="ftpViaMqMessageSenderService" ref="ftpViaMqMessageSender" interface="com.railinc.notifserv.senders.SenderService"/>

</beans>
